name: Lighthouse CI

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Start server and wait
        run: |
          npm run start &
          npx wait-on http://localhost:3000

      - name: Lighthouse checks
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000/
            http://localhost:3000/offline
            http://localhost:3000/shop
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 1
          configPath: ''
          thresholds: '{"performance":0.85,"pwa":0.8,"accessibility":0.9,"best-practices":0.9,"seo":0.9}'